===S.T.A.L.K.E.R. *.spawn compiler/decompiler for every build from 1465===

Дата последних правок: 23 сентября 2011

Кратко: данный acdc предназначен для распаковки all.spawn/level.spawn от любого билда, начиная с 1465. Информацию
о версии спавна скрипт берет из параметров cse_abstract первой читаемой секции (version и script_version), 
в соответствии с чем и распаковывает спавн. Принадлежность объектов к уровням определяется по game.graph.

Добавлена также экспериментальная функция конвертирования спавна из одной версии в другую. На данный момент
поддерживаются все версии сталкера, начиная со 2го патча ТЧ.

Добавлена поддержка спавнов модов. Для распаковки необходима папка конфигов мода.
Вылет "unknown section" исключен. 

Для корректной работы используйте с папкой stkutils последней версии.

Использование:
Кладете all.spawn (или level.spawn) и game.graph в папку с программой, делаете батник (команды ниже),
запускаете батник, радуетесь жизни. Если распаковываете level.spawn, game.graph, очевидно, не нужен.
Также game.graph не нужен в случае ЧН и ЗП - там он вшит прямо в спавн.

===[Распаковка спавна]===
Команда:  acdc [-d spawn_file] [-o outdir] [-l] [-g graph_dir] [-scan <scan_dir>]

-d <spawn_file> - путь до спавна.
-o <outdir> - путь до папки, куда надо распаковать спавн. Если не задана, спавн распаковывается в папку с acdc
-l - ключ для декомпиляции level.spawn
-scan <scan_dir> - путь до папки конфигов геймдаты мода (если распаковываете мод). Путь не должен содержать 
кириллицу или пробелы. Как вариант, можно положить папку config в папку с acdc и запускать 
с таким ключом: -scan config\
-g <graph_dir> - путь до game.graph. Если граф в папке с acdc, ключ можно не указывать. 
Кстати, пути не обязательно должен быть абсолютными - поддерживаются переходы на уровни вверх.
К примеру, такая запись (../graph/) означает, что скрипт выйдет из папки на уровень вверх и будет искать 
game.graph в папке graph.

===[Запаковка спавна]===
Команда:  acdc [-c dir] [-o outfile] [-l] [-idx index_file]

-c <dir> - папка, в которой лежит распакованный спавн. Если работаете в текущей папке, <dir> не нужно.
-o <outfile> - имя результирующего спавна. Если не задано - new.spawn.
-l - ключ для компиляции level.spawn
-idx <index_file> - с этим ключом скрипт сформирует ltx конфиг с секциями вида:

[box_wood_01_0021]
id = 2907
story_id = -1

Полезно, если вы хотите спавнить скриптом не по индексу объекта, а по его имени.
Если указать ключ -idx без пути до конфига, он появится в папке с acdc (spawn_ids).

Другой вариант - в распакованном спавне поставьте для нужной секции метку 'index' (пример - [24]:index),
тогда при компиляции такого спавна в кастом-дату объекта добавится запись типа

[spawn_id]
name = <current_index> ; соответствие имени и текущего id объекта в спавне.

Таким образом, можно будет работать с такой кастом_датой прямо из игры. При распаковке такого спавна
из кастом_даты этот кусок удалится, а метка 'index' восстановится.
При наличии меток в спавне и при запуске компиляции без ключа -idx, сгенерируется лог (spawn_ids.log), 
в котором будут перечислены все 'помеченные' секции.

===[Конвертирование спавна]===
Команда:  acdc -convert <location> [-game1 game1,<old_gvid0>] [-game2 <game2>,<new_gvid0>] [-way]

<location> - название локации, для которой конвертируется спавн. Для конвертации спавна всех локаций из all.spawn 
ставить all.

-game1 - задание старой версии спавна в формате <ключ старой версии>,<старый начальный game_vertex_id локации>.
Разделитель - запятая, без пробелов!
-game2 - задание новой версии спавна в формате <ключ новой версии>,<новый начальный game_vertex_id локации>.
Разделитель - запятая, без пробелов!
-way - заставляет программу также обрабатывать way.

Также поддерживается тонкая настройка конвертации через файл convert.ini. В секции sections есть два параметра:
to_exclude и to_change. В качестве значений to_exclude прописываются имена секций, которые необходимо удалять при 
конвертации (например, respawn не нужен при переносе в ЗП). В качестве значений to_change прописываются 
section_name тех секций, в которых нужно что-то поменять или дополнить. Далее заполняете файл секциями для тех 
section_name, которые вы прописали в to_change. Пример:

[inventory_box]			//section_name для нужных секций
add:custom_data = PREVED	//префикс add используется для тех параметров, в которые нужно добавить
add:game_vertex_id = 10000	//необходимое значение (если число - складывается, если строка - добавляется в конец)
rep:level_vertex_id = 0		//префикс rep используется для параметров, которые необходимо заменить на что-то

Пример: acdc -convert escape -game1 cs4,472 -game2 cop,934 -way

Список ключей версий:

-soc1 - ТЧ, начиная со 2го патча, а также билд 3120
-cs0 - финалка ЧН
-cs3 - 3 патч ЧН
-cs4 - 4 патч ЧН и выше
-cop - ЗП (любой патч)

===[Массовая замена вертексов]===
Команда:  acdc -parse <location> [-game1 <old_gvid0>] [-game2 <new_gvid0>] [-way]

<location> - имя ltx, в котором находится спавн.
-game1 - задание старого начального game_vertex_id локации.
-game2 - задание нового начального game_vertex_id локации.
-way - заставляет программу также обрабатывать way.

Пример: acdc -parse alife_l01_escape.ltx -game1 0 -game2 934 -way

===[Разбивка спавна на level.spawn]===
Использование:   acdc_cop -d *.spawn [-split_spawns] [-scan <scan_dir>]

Ключи:
-split_spawns - разбор all.spawn на level.spawn и level.game для каждого уровня. ACDC должен лежать 
в папке gamedata/spawns, причем в папке gamedata/levels должны лежать содержащиеся в спавне уровни, или хотя бы
level.spawn от них. Скрипт сохранит старые level.spawn и level.game как *bak файлы, и запишет на их место новые.
Достоинство такого способа - сохраняются оригинальные имена граф-поинтов.

======================================
	

История правок:
23 сентября: 
	[i] исправлено предупреждение при запаковке спавна без ключа -idx. Спавн собирался, как надо, 
просто предупреждение нервировало (нашел RedPython)
	[i] теперь sections.ini нулевой длины (из-за прерывания процесса сканирования) удаляется при 
повторном сканировании (Artos)
	[i] генерируемый файл с секциями теперь пропускается при сканировании (Artos)
	[i] переделана data_packet::unpack, так что теперь чтение будет работать быстрей. В acdc наиболее 
заметно на стадии "reading vertices...".
	[i] переделан модуль graph для будушей универсализации perl-скриптов. В распаковке графа незаметно, 
просто предупреждаю, что со старым модулем acdc работать откажется.
19 сентября 2011:
	[+] мелкие доработки вчерашних фичей.
	[+] добавлена функция разбивки all.spawn на level.spawn и level.game.
	[i] исправлена распаковка/запаковка level.spawn, поломанная в какой-то из версий.

18 сентября 2011:
	[+] добавлена поддержка меток для записи индексов в кастом_дату.
	[+] добавлена функция генерирования конфига с индексами объектов в привязке к их именам.
	[+] добавлены некоторые дебаг-сообщения для легкого нахождения синтаксических ошибок в 
alife_...ltx.

17 сентября 2011:
	[+] добавлена возможность компиляции из папки.
	[+] добавлена возможность задания пути до game.graph.

30 августа 2011:
	[i] переделан алгоритм сканирования конфигов.
	[i] добавлена поддержка спавна NLC6.

26 июля 2011:
	[i] исправлены разные ошибки.
	[i] ключ -2942 больше не поддерживается - acdc теперь автоматически корректирует алгоритм распаковки для 
	первого	патча ТЧ.

25 июля 2011:
	[+] импортер game.graph вынесен в отдельный модуль.
	[+] все модули переведены на вывод дебаг сообщений вместо маловнятного "died on line ..."
	[i] исправлена распаковка спавнов билдов 2212-2218 (вылет 'no such level for vertice').
	[i] исправлена распаковка спавнов билда 2232 (вылет по m_rat_e).
	[i] исправлена распаковка спавна билда 1902.

11 июля 2011
	[+] добавлен вывод дебаг-сообщений для лучшего понимания вылетов скриптов.
 	[i] исправлена распаковка некоторых мод-спавнов.

20 июня 2011
	[i] секции в конвертированном спавне теперь сортируются по алфавиту относительно section_name

19 июня 2011
	[+] добавлен конфигурационный файл для тонкой настройки конвертации спавна.
	[i] переработана функция конвертации спавна. Полностью поддерживается конвертация из ТЧ в более поздние
спавны.

9 июня 2011
	[+] добавлена поддержка спавнов модов.
	[i] исправлено определение класса m_rat_e при использовании таких секций в финалках.

7 июня 2011
	[i] исправлены ошибки распаковки и запаковки ряда билдов.

23 мая 2011
	[i] исправлены некоторые ошибки чтения графа.

18 мая 2011
	[+] добавлена поддержка встроенных в спавн графов.

17 мая 2011
	[i] исправлены stkutils, в прошлую версию попали модули от обычного acdc
	[+] добавлена функция массовой замены вертексов в распакованном спавне
	[+] добавлена функция определения принадлежности объекта к уровню по глобальному графу. 
Больше никакой возни с level.pm

15 мая 2011
	[i] исправлена распаковка некоторых level.spawn от третьего патча ЧН.
================================================================
Копирайты:
ACDC для ТЧ - bardak, для ЗП - bardak, Kolmogor. Все остальное - K.D.
Используйте/выкладывайте где и как хотите, с указанием авторов.